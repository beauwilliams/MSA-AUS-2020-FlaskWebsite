{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/serve/index.ts"],"names":[],"mappings":";;;;;;;;;AAAA,OAAO,EAAE,UAAU,EAAE,MAAM,IAAI,CAAC;AAEhC,OAAO,OAAO,MAAM,SAAS,CAAC;AAC9B,OAAO,EAAc,MAAM,YAAY,CAAC;AACxC,OAAO,KAAK,MAAM,OAAO,CAAC;AAC1B,OAAO,EAAE,IAAI,EAAE,MAAM,MAAM,CAAC;AAC5B,OAAO,EAAE,OAAO,EAAE,eAAe,EAAE,MAAM,MAAM,CAAC;AAChD,OAAO,EAAE,IAAI,EAAE,MAAM,gBAAgB,CAAC;AACtC,OAAO,EAAE,OAAO,EAAE,MAAM,eAAe,CAAC;AACxC,OAAO,EAAE,QAAQ,EAAE,MAAM,WAAW,CAAC;AAErC,MAAM,KAAK,GAAG,aAAa,CAAA,OAAO,CAAC,eAAe,CAAC,CAAC;AAKpD,OAAO,EAAE,KAAK,EAAE,MAAM,UAAU,CAAC;AACjC,OAAO,EAAE,OAAO,EAAE,MAAM,kBAAkB,CAAC;AAC3C,OAAO,EAAE,KAAK,EAAE,MAAM,gBAAgB,CAAC;AACvC,OAAO,EAAE,OAAO,EAAE,MAAM,cAAc,CAAC;AAEvC,OAAO,EAAE,cAAc,EAAE,sBAAsB,EAAE,mBAAmB,EAAU,mBAAmB,EAAE,MAAM,UAAU,CAAC;AACpH,OAAO,EAAE,KAAK,EAAE,MAAM,SAAS,CAAC;AAChC,OAAO,EAAE,WAAW,EAAE,MAAM,gBAAgB,CAAC;AAC7C,OAAO,EAAE,eAAe,EAAE,MAAM,UAAU,CAAC;AAC3C,OAAO,EAAE,YAAY,EAAE,MAAM,iBAAiB,CAAC;AAG/C,MAAM,UAAU,KAAK,CACnB,IAAY,EACZ,MAAqB,EACrB,OAAuB,EACvB,cAAqC,EACrC,aAA6B;IAE7B,IAAI,KAAK,GAAG,IAAI,eAAe,CAAqC,EAAE,MAAM,EAAE,sBAAsB,EAAE,CAAC,CAAC;IAExG,MAAM,mCAAQ,MAAM,KAAE,MAAM,kCAAO,MAAM,CAAC,MAAM,KAAE,IAAI,EAAE,CAAC,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,eAAe,CAAC,MAAI,CAAC;IACrG,MAAM,MAAM,GAAG,KAAK,CAAC,EAAE,IAAI,EAAE,aAAa,EAAE,EAAE,aAAa,IAAI,EAAE,CAAC,CAAC;IAEnE,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,sBAAsB,EAAE,CAAC,CAAC;IAC/C,KAAK,CAAC,MAAM,EAAE,OAAO,EAAE,cAAc,EAAE,MAAM,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE;QAC3D,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,mBAAmB,EAAE,CAAC,CAAC;QAC5C,OAAO,CAAC,GAAG,CAAC,KAAK,CAAA,kCAAkC,CAAC,CAAC;QACrD,MAAM,QAAQ,GAAG,IAAI,OAAO,EAAQ,CAAC;QACrC,KAAK,CAAC,IAAI,EAAE,MAAM,EAAE,QAAQ,CAAC,CAAC,SAAS,CAAC,CAAM,QAAQ,EAAC,EAAE;YACvD,IAAI,QAAQ,KAAK,QAAQ;gBAAE,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,sBAAsB,EAAE,CAAC,CAAC;iBACrE;gBACH,IAAI,QAAQ,KAAK,KAAK,EAAE;oBACtB,MAAM,CAAC,GAAG,GAAG,MAAM,OAAO,CAAC,MAAM,CAAC,CAAC;iBACpC;gBAED,OAAO,CACL,QAAQ,KAAK,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,QAAQ,EAAE,MAAM,CAAC,EAC5D,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,MAAM,CAChC,CAAC,IAAI,CAAC,GAAG,EAAE;oBACV,OAAO,CAAC,GAAG,CAAC,KAAK,CAAA,oCAAoC,CAAC,CAAC;oBACvD,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,mBAAmB,EAAE,CAAC,CAAC;oBAC5C,QAAQ,CAAC,IAAI,EAAE,CAAC;gBAClB,CAAC,CAAC,CAAC,KAAK,CAAC,KAAK,CAAC,EAAE;oBACf,OAAO,CAAC,GAAG,CAAC,KAAK,CAAA,gCAAgC,CAAC,CAAC;oBACnD,OAAO,CAAC,GAAG,CAAC,CAAA,KAAK,aAAL,KAAK,uBAAL,KAAK,CAAE,OAAO,KAAI,KAAK,CAAC,CAAC;oBACrC,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,mBAAmB,EAAE,KAAK,EAAE,CAAA,KAAK,aAAL,KAAK,uBAAL,KAAK,CAAE,OAAO,KAAI,KAAK,EAAE,CAAC,CAAC;oBAC5E,QAAQ,CAAC,IAAI,EAAE,CAAC;gBAClB,CAAC,CAAC,CAAC;aACJ;QACH,CAAC,CAAA,CAAC,CAAC;QAEH,WAAW,CAAC,IAAI,EAAE,MAAM,EAAE,KAAK,CAAC,CAAC,SAAS,CAAC,QAAQ,CAAC,EAAE;YACpD,OAAO,CAAC,GAAG,CAAC,KAAK,CAAA,qBAAqB,QAAQ,iCAAiC,CAAC,CAAC;YACjF,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,sBAAsB,EAAE,CAAC,CAAC;YAC/C,UAAU,CAAC,GAAG,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,EAAC,MAAM,EAAE,mBAAmB,EAAC,CAAC,EAAE,GAAG,CAAC,CAAC;QACnE,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC,KAAK,CAAC,KAAK,CAAC,EAAE;QACf,OAAO,CAAC,GAAG,CAAC,KAAK,CAAA,8BAA8B,CAAC,CAAC;QACjD,OAAO,CAAC,GAAG,CAAC,CAAA,KAAK,aAAL,KAAK,uBAAL,KAAK,CAAE,OAAO,KAAI,KAAK,CAAC,CAAC;QACrC,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,mBAAmB,EAAE,KAAK,EAAE,CAAA,KAAK,aAAL,KAAK,uBAAL,KAAK,CAAE,OAAO,KAAI,KAAK,EAAE,CAAC,CAAC;QAC5E,KAAK,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,GAAG,EAAE;YAE/C,iDAAiD;YACjD,yEAAyE;YACzE,2DAA2D;YAC3D,mFAAmF;YACnF,UAAU,CAAC,UAAU,EAAE,IAAI,IAAI,EAAE,EAAE,IAAI,IAAI,EAAE,CAAC,CAAC;QACjD,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,MAAM,GAAG,GAAG,OAAO,EAAE,CAAC;IAAC,EAAE,CAAC,GAAG,CAAC,CAAC;IAC/B,GAAG,CAAC,GAAG,CAAC,cAAc,EAAE,CAAC,CAAC,EAAE,GAAG,EAAE,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC;IAC1D,GAAqB,CAAC,EAAE,CAAC,cAAc,EAAE,EAAE,CAAC,EAAE;QAC7C,MAAM,GAAG,GAAG,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QAC7D,EAAE,CAAC,EAAE,CAAC,OAAO,EAAE,GAAG,EAAE,CAAC,GAAG,CAAC,WAAW,EAAE,CAAC,CAAC;QACxC,EAAE,CAAC,EAAE,CAAC,OAAO,EAAE,GAAG,EAAE,CAAC,GAAG,CAAC,WAAW,EAAE,CAAC,CAAC;IAC1C,CAAC,CAAC,CAAC;IAEH,GAAG,CAAC,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,SAAS,EAAE,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;IAEnE,GAAG,CAAC,GAAG,CAAC,GAAG,MAAM,CAAC,IAAI,CAAC,SAAS,IAAI,EAAE,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE;QACjD,MAAM,SAAS,GAAG,GAAG,CAAC,WAAW,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;QACrF,MAAM,QAAQ,GAAG,CAAC,SAAS,KAAK,GAAG,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,SAAS,CAAC,GAAG,OAAO,CAAC;QACrE,MAAM,QAAQ,GAAG,IAAI,CAAC,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,QAAQ,CAAC,CAAC;QACxD,GAAG,CAAC,QAAQ,CAAC,QAAQ,EAAE,EAAE,EAAE,GAAG,CAAC,EAAE;YAC/B,IAAI,GAAG,EAAE;gBACP,IAAI,KAAK,CAAC,KAAK,CAAC,MAAM,KAAK,sBAAsB,EAAE;oBACjD,OAAO,CAAC,YAAY,CAAC;yBACpB,SAAS,EAAE;yBACX,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;iBAC3C;qBACI;oBACH,OAAO,CAAC,GAAG,EAAE,CAAC;oBACd,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC,CAAC;oBACxC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,GAAG,CAAC,WAAW,CAAC,CAAC;oBAC/C,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC;oBAC7B,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,4BAA4B,CAAC,CAAC,CAAC;oBACxE,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC,MAAM,EACpE,GAAG,CAAC,WAAW,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC;oBAC1D,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC;oBACpD,OAAO,CAAC,GAAG,EAAE,CAAC;oBACd,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,QAAQ,CAAC,MAAM,CAAC,GAAG,CAAC,SAAS,CAAC,GAAG,OAAO,CAAC,EAAE,EAAE,EAAE,GAAG,CAAC,EAAE;wBAC7F,IAAI,GAAG;4BAAE,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;oBAC/C,CAAC,CAAC,CAAC;iBACJ;aACF;QACH,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,EAAE,GAAG,EAAE;QAC/B,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,GAAG,kBAAkB;cAC/C,KAAK,CAAC,IAAI,CAAC,oBAAoB,MAAM,CAAC,GAAG,CAAC,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC,CAAC,CAAA;IACrF,CAAC,CAAC,CAAC;AACL,CAAC","sourcesContent":["import { utimesSync } from 'fs';\nimport _watch from 'node-watch';\nimport express from 'express';\nimport ws, { Router } from 'express-ws';\nimport chalk from 'chalk';\nimport { join } from 'path';\nimport { Subject, BehaviorSubject } from 'rxjs';\nimport { take } from 'rxjs/operators';\nimport { compile } from '@connectv/sdh';\nimport { _dropExt } from 'rxline/fs';\nimport { Configuration } from 'webpack';\nconst merge = /*#__PURE__*/require('webpack-merge');\nimport { TransportedFunc } from '@connectv/sdh/dist/es6/dynamic/transport/index';\n\nimport { CodedocConfig } from '../config';\nimport { ContentBuilder } from '../build/types';\nimport { build } from '../build';\nimport { rebuild } from '../build/rebuild';\nimport { files } from '../build/files';\nimport { loadToC } from '../build/toc';\n\nimport { StatusCheckURL, StatusBuildingResponse, StatusReadyResponse, Status, StatusErrorResponse } from './config';\nimport { watch } from './watch';\nimport { watchAssets } from './watch-assets';\nimport { reloadOnChange$ } from './reload';\nimport { buildingHtml } from './building-html';\n\n\nexport function serve(\n  root: string,\n  config: CodedocConfig,\n  builder: ContentBuilder,\n  themeInstaller: TransportedFunc<void>,\n  webpackConfig?: Configuration,\n) {\n  let state = new BehaviorSubject<{ status: Status, error?: string }>({ status: StatusBuildingResponse });\n\n  config = { ...config, bundle: { ...config.bundle, init: [...config.bundle.init, reloadOnChange$] } };\n  const wpconf = merge({ mode: 'development' }, webpackConfig || {});\n\n  state.next({ status: StatusBuildingResponse });\n  build(config, builder, themeInstaller, wpconf).then(assets => {\n    state.next({ status: StatusReadyResponse });\n    console.log(chalk`{greenBright #} Documents built!`);\n    const notifier = new Subject<void>();\n    watch(root, config, notifier).subscribe(async buildreq => {\n      if (buildreq === 'queued') state.next({ status: StatusBuildingResponse });\n      else {\n        if (buildreq === 'all') {\n          assets.toc = await loadToC(config);\n        }\n\n        rebuild(\n          buildreq === 'all' ? files(config) : files(buildreq, config),\n          config, builder, assets, wpconf\n        ).then(() => {\n          console.log(chalk`{greenBright #} Documents Rebuilt!`);\n          state.next({ status: StatusReadyResponse });\n          notifier.next();\n        }).catch(error => {\n          console.log(chalk`{redBright # REBUILD FAILED!!}`);\n          console.log(error?.message || error);\n          state.next({ status: StatusErrorResponse, error: error?.message || error });\n          notifier.next();\n        });\n      }\n    });\n\n    watchAssets(root, config, state).subscribe(filename => {\n      console.log(chalk`{gray # change in ${filename}, issuing reload to client ...}`);\n      state.next({ status: StatusBuildingResponse });\n      setTimeout(() => state.next({status: StatusReadyResponse}), 300);\n    });\n  }).catch(error => {\n    console.log(chalk`{redBright # BUILD FAILED!!}`);\n    console.log(error?.message || error);\n    state.next({ status: StatusErrorResponse, error: error?.message || error });\n    watch(root, config).pipe(take(1)).subscribe(() => {\n\n      // --> so this is shaky and requires explanation:\n      // --> we need to restart the whole process when the initial build fails.\n      // --> in order to do so, we simply touch the current file.\n      // --> since this file is imported, saving it should restart ts-node-dev's process.\n      utimesSync(__filename, new Date(), new Date());\n    });\n  });\n\n  const app = express(); ws(app);\n  app.get(StatusCheckURL, (_, res) => res.json(state.value));\n  (app as any as Router).ws(StatusCheckURL, ws => {\n    const sub = state.subscribe(v => ws.send(JSON.stringify(v)));\n    ws.on('error', () => sub.unsubscribe());\n    ws.on('close', () => sub.unsubscribe());\n  });\n\n  app.use(config.dest.namespace, express.static(config.dest.assets));\n\n  app.get(`${config.dest.namespace}/*`, (req, res) => {\n    const normalUrl = req.originalUrl.substr(config.dest.namespace.length).split('?')[0];\n    const filename = (normalUrl === '/' ? 'index' : normalUrl) + '.html';\n    const filepath = join(root, config.dest.html, filename);\n    res.sendFile(filepath, {}, err => {\n      if (err) {\n        if (state.value.status === StatusBuildingResponse) {\n          compile(buildingHtml)\n          .serialize()\n          .then(html => res.status(200).send(html));\n        }\n        else {\n          console.log();\n          console.log(chalk.red('# Not Found::'));\n          console.log(chalk.red('# ') + req.originalUrl);\n          console.log(chalk.red('# '));\n          console.log(chalk.red('# ') + chalk.gray('tried the following paths:'));\n          console.log(chalk.red('# ') + chalk.gray(join(root, config.dest.assets, \n            req.originalUrl.substr(config.dest.namespace.length))));\n          console.log(chalk.red('# ') + chalk.gray(filepath));\n          console.log();\n          res.sendFile(join(root, config.dest.html, _dropExt(config.src.not_found) + '.html'), {}, err => {\n            if (err) res.status(404).send('Not Found!!');\n          });\n        }\n      }\n    });\n  });\n\n  app.listen(config.dev.port, () => {\n    console.log(chalk.greenBright('# ') + 'Serving docs on ' \n          +  chalk.cyan(`http://localhost:${config.dev.port}${config.dest.namespace}`))\n  });\n}\n"]}