{"version":3,"file":"reload.js","sourceRoot":"","sources":["../../../src/serve/reload.tsx"],"names":[],"mappings":"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","sourcesContent":["import { RendererLike, ComponentThis, ref } from '@connectv/html';\nimport { interval, of, merge } from 'rxjs';\nimport { ajax } from 'rxjs/ajax';\nimport { webSocket } from 'rxjs/webSocket';\nimport { switchMap, catchError, map } from 'rxjs/operators';\nimport { funcTransport } from '@connectv/sdh/transport';\nimport { default as AnsiUp } from 'ansi_up';\n\nimport { StatusCheckURL, StatusBuildingResponse, StatusReadyResponse, StatusErrorResponse } from './config';\nimport { getRenderer } from '../transport/renderer';\nimport { Loading } from '../components/util/loading';\nimport { Overlay } from '../components/util/overlay';\n\n\nexport function Toast(this: ComponentThis, _: any, renderer: RendererLike<any, any>) {\n  const holder = ref<HTMLElement>();\n  this.track({\n    bind() {\n      setTimeout(() => holder.$.style.transform = '', 10);\n    }\n  });\n\n  return <div _ref={holder} style={`\n    position: fixed;\n    bottom: 32px; right: 32px;\n    z-index: 10000;\n    background: rgba(64, 64, 64, .65);\n    color: white;\n    padding: 24px;\n    border-radius: 8px;\n    transform: translateY(200px);\n    backdrop-filter: blur(12px);\n    -webkit-backdrop-filter: blur(12px);\n    transition: transform .3s;\n  `}>\n   <Loading/>  &ensp;Rebuilding documents ...\n  </div>;\n}\n\n\nexport function reloadOnChange() {\n  let building = false;\n  let error = false;\n  let errorMsg: string;\n  const renderer = getRenderer();\n  let toast: HTMLElement;\n  let overlay: HTMLElement;\n  const ansiUp = new AnsiUp();\n\n  const buildingMode = () => {\n    if (!building) {\n      building = true;\n      error = false;\n      errorMsg = '';\n      if (toast) toast.remove();\n      if (overlay) overlay.remove();\n      toast = renderer.render(<Toast/>).on(document.body);\n    }\n  }\n\n  const showError = (err: string) => {\n    console.log(error);\n    if (!error || errorMsg !== err) {\n      error = true;\n      errorMsg = err;\n      building = false;\n      if (toast) toast.remove();\n      if (overlay) overlay.remove();\n      overlay = renderer.render(<Overlay sticky={true}>\n        <pre \n          style=\"text-align: left; font-size: 14px; background: rgba(0, 0, 0, .35); padding: 8px; border-radius: 8px;\" \n          _innerHTML={ansiUp.ansi_to_html(errorMsg)}/>\n      </Overlay>).on(document.body);\n    }\n  }\n\n  merge(\n    webSocket({\n       url: (window.location.protocol === 'https') ? 'wss://' : 'ws://'\n            + window.location.host\n            + StatusCheckURL,\n        closeObserver: { next: () => buildingMode() }\n    }).pipe(catchError(() => of())),\n    interval(500).pipe(\n      switchMap(() => ajax({\n          url: StatusCheckURL,\n          responseType: 'json',\n          timeout: 200,\n        })\n        .pipe(catchError(() => of(buildingMode())))\n      ),\n      map(result => result ? result.response : undefined)\n    )\n  ).subscribe(state => {\n    if (state) {\n      if (state.status === StatusBuildingResponse) buildingMode();\n      else if (state.status === StatusErrorResponse) showError(state.error);\n      else if (state.status === StatusReadyResponse && building) {\n        location.reload();\n      }\n    }\n  });\n}\n\n\nexport const reloadOnChange$ = /*#__PURE__*/funcTransport(reloadOnChange);\n"]}