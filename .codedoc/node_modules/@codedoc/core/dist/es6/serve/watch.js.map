{"version":3,"file":"watch.js","sourceRoot":"","sources":["../../../src/serve/watch.ts"],"names":[],"mappings":"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","sourcesContent":["import _watch from 'node-watch';\nimport chalk from 'chalk';\nimport { join } from 'path';\nimport { Subject, BehaviorSubject, of, Observable } from 'rxjs';\nimport { buffer, debounceTime, filter, tap, delayWhen } from 'rxjs/operators';\n\nimport { CodedocConfig } from '../config';\n\n\nexport function watch(\n  root: string,\n  config: CodedocConfig,\n  notifier?: Observable<void>,\n) {\n  const watchbase = join(root, config.src.base, '/');\n  const filechange$ = new Subject<string>();\n  const request$ = new Subject<string[] | 'all' | 'queued'>();\n  const build$ = new BehaviorSubject<boolean>(false);\n\n  _watch(watchbase, {\n    recursive: true,\n    filter: (f: string) => (\n      config.src.pick.test(f) && !config.src.drop.test(f) ||\n      config.src.toc === f.substr(watchbase.length)\n    ),\n  }, (event, filename) => {\n    if (event === 'update')\n      filechange$.next(filename.substr(watchbase.length))\n  });\n\n  filechange$.pipe(\n    tap(filename => {\n      if (notifier)\n        console.log(chalk`{blue # Changes in {magenta ${join(config.src.base, filename)}} queueing ...}`);\n      request$.next('queued');\n    }),\n    buffer(\n      filechange$.pipe(\n        debounceTime(500), \n        delayWhen(() => !build$.value ? of(true) : build$.pipe(filter(_ => !_)))\n      )\n    ),\n    filter(chanegs => chanegs.length > 0)\n  ).subscribe(changedFiles => {\n    if (notifier) {\n      build$.next(true);\n      console.log(chalk`{gray # Rebuilding due to changes ...}`);\n    }\n    changedFiles = changedFiles.filter((file, index) => changedFiles.indexOf(file) === index);\n    if (changedFiles.includes(config.src.toc)) {\n      request$.next('all');\n    } else {\n      request$.next(changedFiles);\n    }\n\n    notifier?.subscribe(() => build$.next(false));\n  });\n\n  return request$;\n}"]}