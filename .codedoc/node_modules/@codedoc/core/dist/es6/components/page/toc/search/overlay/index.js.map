{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../../../src/components/page/toc/search/overlay/index.tsx"],"names":[],"mappings":"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","sourcesContent":["import { state, pipe, pin, map, pack, emission, filter, sink } from '@connectv/core';\nimport { debounceTime, startWith, share } from 'rxjs/operators';\nimport { RendererLike, ref, List } from '@connectv/html';\nimport { ThemedComponentThis } from '@connectv/jss-theme';\n\nimport { CodedocTheme } from '../../../../../theme';\nimport { ToCSearchOverlayStyle } from './style';\nimport { Loading } from '../../../../util/loading';\nimport { getConfig } from '../../../../../transport/config';\n\n\nexport interface ToCSearchOverlayOptions {\n  placeholder: string;\n  query: any;\n  results: any;\n}\n\n\nexport function ToCSearchOverlay(\n  this: ThemedComponentThis<CodedocTheme>,\n  options: ToCSearchOverlayOptions,\n  renderer: RendererLike<any, any>,\n) {\n  const classes = this.theme.classes(ToCSearchOverlayStyle);\n  const holder = ref<HTMLElement>();\n  const input = ref<HTMLInputElement>();\n  const toc = ref<HTMLElement>();\n\n  const findFocus = () => {\n    let focused: HTMLElement | undefined = undefined;\n    let prev: HTMLElement | undefined = undefined;\n    let next: HTMLElement | undefined = undefined;\n    let first: HTMLElement | undefined = undefined;\n    let last: HTMLElement | undefined = undefined;\n\n    holder.$.querySelectorAll('a[tabindex]').forEach(a$ => {\n      if (!first) first = a$ as HTMLElement;\n      if (a$ === document.activeElement) focused = a$ as HTMLElement;\n      else {\n        if (!focused) prev = a$ as HTMLElement;\n        else if (!next) next = a$ as HTMLElement;\n      }\n      last = a$ as HTMLElement;\n    });\n\n    const res: { prev?: HTMLElement; next?: HTMLElement } = {};\n    res.next = next || first;\n    res.prev = prev || last;\n\n    return res;\n  };\n\n  this.track({\n    bind() {\n      input.$.focus();\n      holder.$.classList.add('active');\n      toc.resolve(document.getElementById('-codedoc-toc') || <fragment/>);\n      if (!('backdropFilter' in holder.$.style) && !('-webkit-backdrop-filter' in holder.$.style)) {\n        holder.$.style.background = 'rgba(64, 64, 64, .95)';\n      }\n    }\n  });\n\n  const query = state(localStorage.getItem('-codedoc-search-query') || '');\n  const loading = state(false);\n\n  const queryOut = this.expose.out('query');\n  const results = this.expose.in('results', pin())\n    .to(pipe(share()))\n    .to(map((links: string[]) => {\n      const res = links.map(l => {\n        const conf = getConfig();\n        if (conf) l = conf.namespace + l;\n        return {link: l, title: tocLinkTitle(l) };\n      });\n\n      if (query.value.length > 0) {\n        toc.$.querySelectorAll('a').forEach(a$ => {\n          if (a$.textContent?.toLowerCase().includes(query.value.toLowerCase())\n            && a$.getAttribute('href')\n            && !links.includes(a$.getAttribute('href') || '')\n          ) res.push({ link: a$.getAttribute('href') || '',\n                        title: a$.textContent })\n        });\n      }\n\n      return res;\n    }))\n    .to(sink(res => {\n      if (res.length > 0) {\n        localStorage.setItem('-codedoc-search-query', query.value)\n        localStorage.setItem('-codedoc-search-res', JSON.stringify(res));\n      }\n    }))\n    .to(pipe(startWith(emission(JSON.parse(localStorage.getItem('-codedoc-search-res') || '[]')))))\n  ;\n\n  query\n    .to(filter((q: string) => q && q.trim().length > 0))\n    .to(\n      loading.from(map(() => true)),\n      queryOut.from(pipe(debounceTime(1000)))\n    );\n\n  results.to(map(() => false)).to(loading);\n\n  const hideEmpty =\n    pack(query, results, loading)\n    .to(map(([_query, _results, _loading]: any) => {\n      if (_loading) return true;\n      else return !_query || _query.trim().length == 0 || _results.length > 0;\n    }));\n\n  const tocLinkTitle = (link: string) => toc.$.querySelector(`a[href=\"${link}\"]`)?.textContent || link;\n\n  const close = (clean=true) => {\n    holder.$.remove();\n    if (clean) {\n      localStorage.removeItem('-codedoc-search-query');\n    }\n  }\n\n  return <div class={classes.overlay} _ref={holder} onkeydown={event => {\n    const key = (event as KeyboardEvent).key;\n    if (key === 'Escape') {\n      event.preventDefault();\n      event.stopPropagation();\n      close();\n    }\n\n    if (key === 'ArrowDown') {\n      const focus = findFocus();\n      if (focus.next) {\n        focus.next.focus();\n        event.preventDefault();\n        event.stopPropagation();\n      }\n    }\n\n    if (key === 'ArrowUp') {\n      const focus = findFocus();\n      if (focus.prev) {\n        focus.prev.focus();\n        event.preventDefault();\n        event.stopPropagation();\n      }\n    }\n\n    if (key === 'ArrowLeft' || key === 'ArrowRight') event.stopPropagation();\n  }}>\n    <div class={classes.content}>\n      <div class=\"top\">\n        <input placeholder={options.placeholder} type=\"text\" _ref={input} _state={query}/>\n        <div class={classes.close} onclick={() => {\n          if (query.value.length > 0) query.value = '';\n          else close();\n        }}/>\n      </div>\n      <div class={classes.results}>\n        <div class=\"loading\" hidden={loading.to(map((_: boolean) => !_))}><Loading/></div>\n        <div class=\"empty\" hidden={hideEmpty}>No Results!</div>\n        <div hidden={loading}>\n          <List of={results} each={result =>\n            <a href={result.sub('link')} tabindex=\"0\" onclick={() => {\n              close(false);\n              window.dispatchEvent(new CustomEvent('on-navigation-search', {detail: {query: query.value}}));\n            }}><span class=\"title\">{result.sub('title')}</span>\n                <span class=\"current\" hidden={result.sub('link').to(map((l: string) => l !== location.pathname))}>\n                  Search on Current Page\n                </span>\n              </a>\n          } />\n        </div>\n      </div>\n    </div>\n  </div>\n}\n\n\nexport { ToCSearchOverlayStyle } from './style';"]}