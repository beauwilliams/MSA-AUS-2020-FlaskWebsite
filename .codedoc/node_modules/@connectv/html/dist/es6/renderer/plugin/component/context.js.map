{"version":3,"file":"context.js","sourceRoot":"","sources":["../../../../../src/renderer/plugin/component/context.ts"],"names":[],"mappings":"AACA,OAAO,KAAK,CAAC,MAAM,4BAA4B,CAAC;AAChD,OAAO,KAAK,OAAO,MAAM,yBAAyB,CAAC;AAEnD,OAAO,EAAE,cAAc,EAAc,MAAM,WAAW,CAAC;AAGvD,OAAO,EAAqB,mBAAmB,EAAE,gCAAgC,EAAE,MAAM,iBAAiB,CAAC;AAC3G,OAAO,EAAE,YAAY,EAAE,MAAM,MAAM,CAAC;AACpC,OAAO,EAAE,8BAA8B,EAAE,MAAM,4CAA4C,CAAC;AAG5F,MAAM,OAAO,aAAa;IAA1B;QA2CE,aAAQ,GAAG,cAAc,CAAC,IAAI,CAAC;IACjC,CAAC;IAzCG,OAAO,CACL,CAAuC,EACvC,EAAoC,EACpC,GAAqC,EACrC,MAAgC,EAChC,UAAuC;QAGvC,IAAI,OAAO,GAAG,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,gCAAgC,CAAC,CAAC;QACxE,IAAI,QAAQ,GAAG,GAAG,EAAE,CAAC,OAAO,CAAA,CAAC,CAAA,OAAO,CAAC,cAAc,EAAE,CAAA,CAAC,CAAA,SAAS,CAAC;QAEhE,MAAM,GAAG,GAAyB,EAAE,CAAC;QACrC,MAAM,OAAO,GAAG,CAAI,GAAW,EAAE,SAAa,EAAK,EAAE,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,GAAG,CAAC,GAAG,CAAC,IAAI,SAAS,IAAI,QAAQ,EAAE,CAAC;QACrG,MAAM,CAAC,OAAO,GAAG,OAAO,CAAC;QAEzB,OAAO,CAAC,IAAU,EAAE,EAAE;YACpB,MAAM,GAAG,GAAG,IAAI,YAAY,EAAE,CAAC;YAC/B,MAAM,WAAW,GAAG,UAAU,CAAC,OAAO,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;YAEnE,CAAC,CAAC,MAAM,CAAC;gBACP,IAAI;oBACF,YAAY,CAAC,GAAG,EAAE;wBAChB,IAAI,IAAI,GAAG,IAAI,CAAC;wBAChB,IAAI,IAAI,YAAY,gBAAgB;4BAAE,IAAI,GAAG,CAAC,CAAC,kBAAkB,CAAC,IAAI,CAAC,CAAC;wBAExE,MAAM,GAAG,GAAG,OAAO,CAAC,OAAO,CAAC,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;wBACpD,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,GAAG,EAAE,SAAS,CAAC,EAAE,EAAE;4BAC/C,MAAM,KAAK,GAAG,GAAG,CAAC,GAAG,CAAC,CAAC;4BACvB,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,GAAG,EAAE,KAAK,EAAE,SAAS,EAAE,GAAG,EAAE,IAAI,EAAE,UAAU,CAAC,CAAC;gCACrF,MAAM,IAAI,8BAA8B,CAAC,GAAG,EAAE,SAAS,EAAE,KAAK,CAAC,CAAC;wBACpE,CAAC,CAAC,CAAC;oBACL,CAAC,CAAC,CAAC;gBACL,CAAC;gBACD,KAAK;oBACH,GAAG,CAAC,WAAW,EAAE,CAAC;gBACpB,CAAC;aACF,EAAE,IAAI,CAAC,CAAC;QACX,CAAC,CAAA;IACH,CAAC;CAGJ","sourcesContent":["import { PropsType } from \"../../../shared/types\";\nimport * as L from \"../../../shared/life-cycle\";\nimport * as Context from \"../../../shared/context\";\n\nimport { PluginPriority, PluginHost } from \"../plugin\";\n\nimport { CompType } from \"./types\";\nimport { CompProcessPlugin, isCompContextPlugin, isDefaultReactiveRecipientPlugin } from \"./basic-plugins\";\nimport { Subscription } from \"rxjs\";\nimport { UnhandledComponentContextError } from \"./errors/unhandled-component-context.error\";\n\n\nexport class ContextPlugin<Renderable=RawValue, Tag=CompType<Renderable | string> | string>\n  implements CompProcessPlugin<Renderable, Tag> {\n\n    prepare(\n      _: CompType<RawValue | Renderable, Tag>,\n      __: PropsType<Renderable | RawValue>,\n      ___: (RawValue | Renderable | Node)[],\n      extras: { [name: string]: any; },\n      pluginHost: PluginHost<Renderable, Tag>,\n    ): (node: Node) => void {\n\n      let _plugin = pluginHost.plugins.find(isDefaultReactiveRecipientPlugin);\n      let _default = () => _plugin?_plugin.defaultContext():undefined;\n\n      const map: {[key: string]: any} = {};\n      const context = <T>(key: string, recipient?: T): T => map[key] = map[key] || recipient || _default();\n      extras.context = context;\n\n      return (node: Node) => {\n        const sub = new Subscription();\n        const _ctxPlugins = pluginHost.plugins.filter(isCompContextPlugin);\n\n        L.attach({\n          bind() {\n            setImmediate(() => {\n              let _ref = node;\n              if (node instanceof DocumentFragment) _ref = L.getLifeCycleMarker(node);\n  \n              const ctx = Context.resolve(_ref, Object.keys(map));\n              Object.entries(map).forEach(([key, recipient]) => {\n                const value = ctx[key];\n                if (!_ctxPlugins.find(p => p.wireContext(key, value, recipient, sub, _ref, pluginHost)))\n                  throw new UnhandledComponentContextError(key, recipient, value);\n              });\n            });\n          },\n          clear() {\n            sub.unsubscribe();\n          }\n        }, node);\n      }\n    }\n\n  priority = PluginPriority.High;\n}"]}