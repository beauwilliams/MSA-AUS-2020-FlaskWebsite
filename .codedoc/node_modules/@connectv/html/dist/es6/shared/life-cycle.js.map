{"version":3,"file":"life-cycle.js","sourceRoot":"","sources":["../../../src/shared/life-cycle.ts"],"names":[],"mappings":"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","sourcesContent":["import { Bindable, Clearable, isBindable, isClearable } from '@connectv/core';\n\n\nexport interface LifeCycleInfo {\n  bindables?: Bindable[];\n  clearables?: Clearable[];\n  bound: boolean;\n}\n\n\nexport function lifeCycleInfo(node: Node): LifeCycleInfo | undefined;\nexport function lifeCycleInfo(node: Node, createIfNonExistent: boolean): LifeCycleInfo;\nexport function lifeCycleInfo(node: Node, createIfNonExistent: boolean = false): LifeCycleInfo | undefined {\n  let _node = node as any;\n\n  if (node instanceof DocumentFragment) {\n    let marker = getLifeCycleMarker(node);\n    if (marker) return lifeCycleInfo(marker, createIfNonExistent);\n    else if (createIfNonExistent) {\n      marker = document.createElement('i');\n      marker.setAttribute('hidden', '');\n      setLifeCycleMarker(node, marker);\n      return lifeCycleInfo(marker, true);\n    }\n  }\n  else {\n    if (_node.lifecycle) return _node.lifecycle as LifeCycleInfo;\n    else if (createIfNonExistent) {\n      _node.lifecycle = <LifeCycleInfo>{ bound: false };\n      return _node.lifecycle;\n    }\n  }\n}\n\n\nexport function setLifeCycleMarker(fragment: DocumentFragment, marker: Node) {\n  (fragment as any).lifecycleMarker = marker;\n  if (!fragment.contains(marker))\n    fragment.appendChild(marker);\n}\n\nexport function getLifeCycleMarker(fragment: DocumentFragment) {\n  return (fragment as any).lifecycleMarker;\n}\n\n\nexport function bind(node: Node) {\n  let lifecycle = lifeCycleInfo(node);\n  if (lifecycle) {\n    if (lifecycle.bound) return;\n\n    lifecycle.bound = true;\n    if (lifecycle.bindables) lifecycle.bindables.forEach(b => b.bind());\n  }\n\n  node.childNodes.forEach(bind);\n\n  if (node.parentNode && !(node.parentNode as any).childObserver) {\n    let observer = new MutationObserver(changes => {\n      changes.forEach(change => {\n        if (change.removedNodes)\n          change.removedNodes.forEach(node => setImmediate(() => {\n            if (!document.contains(node))\n              clear(node);\n          }));\n      });\n    });\n\n    observer.observe(node.parentNode, { childList: true });\n    (node.parentNode as any).childObserver = observer;\n    attach(<Clearable>{\n      clear() { observer.disconnect(); }\n    }, node.parentNode);\n  }\n}\n\n\nexport function clear(node: Node) {\n  let lifecycle = lifeCycleInfo(node);\n  if (lifecycle && lifecycle.clearables) lifecycle.clearables.forEach(c => c.clear());\n\n  node.childNodes.forEach(clear);\n}\n\nexport function attach(thing: Bindable | Clearable, node: Node) {\n  let lifecycle = lifeCycleInfo(node, true);\n  if (isBindable(thing)) (lifecycle.bindables || (lifecycle.bindables = [])).push(thing);\n  if (isClearable(thing)) (lifecycle.clearables || (lifecycle.clearables = [])).push(thing);\n}\n\n\nexport function detach(thing: Bindable | Clearable, node: Node) {\n  let lifecycle = lifeCycleInfo(node);\n  if (lifecycle) {\n    if (lifecycle.bindables) lifecycle.bindables = lifecycle.bindables.filter(b => b !== thing);\n    if (lifecycle.clearables) lifecycle.clearables = lifecycle.clearables.filter(b => b !== thing);\n  }\n}\n\n\nexport const LifeCycle = {\n  info: lifeCycleInfo,\n  getMarker: getLifeCycleMarker,\n  setMarker: setLifeCycleMarker,\n  bind,\n  clear,\n  attach,\n  detach\n}"]}