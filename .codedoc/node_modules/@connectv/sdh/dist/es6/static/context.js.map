{"version":3,"file":"context.js","sourceRoot":"","sources":["../../../src/static/context.ts"],"names":[],"mappings":"AAAA,OAAO,EAAa,GAAG,EACd,cAAc,EAEd,mBAAmB,EAAE,gCAAgC,EACrD,8BAA8B,EACtC,MAAM,gBAAgB,CAAC;AACxB,OAAO,EAAE,YAAY,EAAE,MAAM,MAAM,CAAC;AAEpC,OAAO,EAAE,YAAY,EAAE,WAAW,EAAE,sBAAsB,EAAE,MAAM,qBAAqB,CAAC;AAGxF,MAAM,OAAO,aAAa;IAA1B;QAoCE,aAAQ,GAAG,cAAc,CAAC,IAAI,CAAC;IACjC,CAAC;IApCG,OAAO,CACL,CAA4B,EAC5B,EAA2B,EAC3B,GAA4B,EAC5B,MAAgC,EAChC,UAA4B;QAG5B,IAAI,OAAO,GAAG,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,gCAAgC,CAAC,CAAC;QACxE,IAAI,QAAQ,GAAG,GAAG,EAAE,CAAC,OAAO,CAAA,CAAC,CAAA,OAAO,CAAC,cAAc,EAAE,CAAA,CAAC,CAAA,SAAS,CAAC;QAEhE,MAAM,GAAG,GAAyB,EAAE,CAAC;QACrC,MAAM,OAAO,GAAG,CAAI,GAAW,EAAE,SAAa,EAAK,EAAE,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,GAAG,CAAC,GAAG,CAAC,IAAI,SAAS,IAAI,QAAQ,EAAE,CAAC;QACrG,MAAM,CAAC,OAAO,GAAG,OAAO,CAAC;QAEzB,OAAO,CAAC,IAAU,EAAE,EAAE;YACpB,MAAM,GAAG,GAAG,IAAI,YAAY,EAAE,CAAC;YAC/B,MAAM,WAAW,GAAG,UAAU,CAAC,OAAO,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;YAEnE,IAAI,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,MAAM,GAAG,CAAC,EAAE;gBAC/B,YAAY,CAAC,IAAI,EAAE,GAAG,EAAE;oBACtB,IAAI,IAAI,GAAG,IAAI,CAAC;oBAChB,IAAI,IAAI,YAAY,gBAAgB;wBAAE,IAAI,GAAG,WAAW,CAAC,IAAI,CAAC,CAAC;oBAE/D,MAAM,GAAG,GAAG,GAAG,CAAC,OAAO,CAAC,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;oBAChD,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,GAAG,EAAE,SAAS,CAAC,EAAE,EAAE;wBAC/C,MAAM,KAAK,GAAG,GAAG,CAAC,GAAG,CAAC,CAAC;wBACvB,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,GAAG,EAAE,KAAK,EAAE,SAAS,EAAE,GAAG,EAAE,IAAI,EAAE,UAAU,CAAC,CAAC;4BACrF,MAAM,IAAI,8BAA8B,CAAC,GAAG,EAAE,SAAS,EAAE,KAAK,CAAC,CAAC;oBACpE,CAAC,CAAC,CAAC;gBACL,CAAC,EAAE,sBAAsB,CAAC,CAAC;aAC5B;QACH,CAAC,CAAA;IACH,CAAC;CAGJ","sourcesContent":["import { PropsType, CTX, \n         PluginPriority, PluginHost, \n         CompType, CompProcessPlugin, \n         isCompContextPlugin, isDefaultReactiveRecipientPlugin,\n         UnhandledComponentContextError\n} from '@connectv/html';\nimport { Subscription } from 'rxjs';\n\nimport { whenRendered, getLSMarker, WRCallbackHighPriority } from '../shared/lifecycle';\n\n\nexport class ContextPlugin<R, T> implements CompProcessPlugin<R, T> {\n    prepare(\n      _: CompType<RawValue | R, T>,\n      __: PropsType<R | RawValue>,\n      ___: (RawValue | R | Node)[],\n      extras: { [name: string]: any; },\n      pluginHost: PluginHost<R, T>,\n    ): (node: Node) => void {\n\n      let _plugin = pluginHost.plugins.find(isDefaultReactiveRecipientPlugin);\n      let _default = () => _plugin?_plugin.defaultContext():undefined;\n\n      const map: {[key: string]: any} = {};\n      const context = <T>(key: string, recipient?: T): T => map[key] = map[key] || recipient || _default();\n      extras.context = context;\n\n      return (node: Node) => {\n        const sub = new Subscription();\n        const _ctxPlugins = pluginHost.plugins.filter(isCompContextPlugin);\n\n        if (Object.keys(map).length > 0) {\n          whenRendered(node, () => {\n            let _ref = node;\n            if (node instanceof DocumentFragment) _ref = getLSMarker(node);\n\n            const ctx = CTX.resolve(_ref, Object.keys(map));\n            Object.entries(map).forEach(([key, recipient]) => {\n              const value = ctx[key];\n              if (!_ctxPlugins.find(p => p.wireContext(key, value, recipient, sub, _ref, pluginHost)))\n                throw new UnhandledComponentContextError(key, recipient, value);\n            });\n          }, WRCallbackHighPriority);\n        }\n      }\n    }\n\n  priority = PluginPriority.High;\n}\n"]}